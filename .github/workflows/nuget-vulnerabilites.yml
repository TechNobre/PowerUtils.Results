name: 'NuGet vulnerabilites'


on:
  workflow_dispatch: # To can dispatch manually

  # Schedule to run every week on Sunday at 00:00 UTC
  schedule:
    - cron: '0 0 * * 0'

  pull_request:
    types: [opened, reopened, edited, synchronize]
    branches:
      - main


jobs:

  sonar-scanner:
    name: "NuGet vulnerabilites"
    runs-on: ubuntu-latest

    steps:
    - name: "Checkout"
      uses: actions/checkout@v4.2.2

    - name: "Setup .NET"
      uses: actions/setup-dotnet@v4.3.0
      with:
        global-json-file: 'global.json'

    - name: "Restore dependencies"
      run: dotnet restore

    - name: "Build"
      run: dotnet build --configuration Release --no-restore

    - name: "Checking NuGet vulnerabilites"
      run: |
        dotnet list package --vulnerable --include-transitive 2>&1 | tee build.log
        echo "Analyze dotnet list package command log output..."
        grep -q -i "\bcritical\b\|\bhigh\b\|\bmoderate\b\|\blow\b" build.log && { echo "Security Vulnerabilities found on the log output"; exit 1; } || exit 0
